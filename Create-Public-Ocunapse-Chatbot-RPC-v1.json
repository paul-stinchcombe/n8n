{"createdAt":"2025-07-03T01:31:19.909Z","updatedAt":"2025-08-22T03:17:21.000Z","id":"5xQb1wrFuedTG6Wo","name":"Create Public Ocunapse Chatbot RPC v1","active":true,"isArchived":false,"nodes":[{"parameters":{"modelName":"models/embedding-001"},"type":"@n8n/n8n-nodes-langchain.embeddingsGoogleGemini","typeVersion":1,"position":[1056,304],"id":"2854997c-6545-474d-8288-78dc88fb24d9","name":"Embeddings Google Gemini","credentials":{"googlePalmApi":{"id":"06fjQHyU4iIkhwT3","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $('Webhook').item.json.body.text }}","options":{}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1,"position":[1184,304],"id":"acea5073-1048-4929-9661-1d5207789eb5","name":"Default Data Loader"},{"parameters":{"chunkSize":200,"options":{}},"type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","typeVersion":1,"position":[1280,512],"id":"aa0a5349-25bb-4d56-8082-84aae87ac45e","name":"Recursive Character Text Splitter"},{"parameters":{"httpMethod":"POST","path":"chatbot/admin","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1104,560],"id":"070cbea6-39f6-41e0-98f5-00506b6fb736","name":"Webhook","webhookId":"272e7f67-b043-4125-852e-59362f6f259e"},{"parameters":{"options":{"timezone":"Asia/Kuala_Lumpur"}},"type":"n8n-nodes-base.dateTime","typeVersion":2,"position":[-880,560],"id":"b29ce7d0-bde5-43c5-9422-63b0cae48b43","name":"Date & Time"},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE {{ $('Set Table Prefix').item.json.tablePrefix }}_embeddings (\n  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY, \n  text TEXT, \n  metadata JSONB, \n  embedding VECTOR\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[608,80],"id":"4a57ad5a-76ab-4a74-a7f5-d68ae737084d","name":"Execute a SQL query","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"63fce80f-569c-480d-b950-85358c92e9f3","leftValue":"={{ $('Validate API Key').item.json.keys().length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-432,560],"id":"bda989b5-a1aa-484b-9f6d-2d66a13d87cb","name":"If"},{"parameters":{"respondWith":"json","responseBody":"{\n  \"success\": false,\n  \"error\": \"API key invalid\"\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[608,1264],"id":"ca4bf58e-fe99-4d80-bc05-e3e47b654eb1","name":"API Key Error","notesInFlow":false},{"parameters":{"workflowId":{"__rl":true,"value":"QXcjQgIZF4bqD5kF","mode":"list","cachedResultName":"Ocunapse Public Chatbot Validate API Key v1"},"workflowInputs":{"mappingMode":"defineBelow","value":{"apikey":"={{ $('Webhook').item.json.headers['x-api-key'] }}","currentDate":"={{ $json.currentDate }}"},"matchingColumns":[],"schema":[{"id":"apikey","displayName":"apikey","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"currentDate","displayName":"currentDate","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[-656,560],"id":"b9378010-9e73-4d12-9b5c-421f58a7d637","name":"Validate API Key","alwaysOutputData":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.action.toLowerCase() }}","rightValue":"embed","operator":{"type":"string","operation":"equals"},"id":"cfeab527-fbf6-4980-b324-a366d0460469"}],"combinator":"and"},"renameOutput":true,"outputKey":"Embed"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"12c97769-9350-47d0-815d-6971396c1397","leftValue":"={{ $('Webhook').item.json.body.action.toLowerCase() }}","rightValue":"get_system","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Get System Prompt"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e832a967-7e09-4531-a138-649559036a4f","leftValue":"={{ $('Webhook').item.json.body.action.toLowerCase() }}","rightValue":"set_system","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Set System Prompt"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"afdd99b8-05c0-41e2-b7ea-5be071bace89","leftValue":"={{ $('Webhook').item.json.body.action.toLowerCase() }}","rightValue":"embed_products","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Embed Products"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1086d053-ddb6-454a-8c6c-94759839a39c","leftValue":"={{ $('Webhook').item.json.body.action.toLowerCase() }}","rightValue":"check_apikey","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Check API Key"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[272,496],"id":"d6e9d867-26af-4531-a75e-c19c17c6ee90","name":"Switch"},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true, \n  \"prompt\": \"{{ $json.systemPrompt }}\"\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[608,352],"id":"cfba3c1f-a776-4fff-bb0c-9cd55030004d","name":"Return System Prompt"},{"parameters":{"operation":"update","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"User","mode":"list","cachedResultName":"User"},"columns":{"mappingMode":"defineBelow","value":{"id":"={{ $('Validate API Key').item.json.id }}","systemPrompt":"={{ $('Webhook').item.json.body.prompt }}","updatedAt":"={{ $('Date & Time').item.json.currentDate }}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":true,"defaultMatch":true,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"email","displayName":"email","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"name","displayName":"name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"company","displayName":"company","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"phone","displayName":"phone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"createdAt","displayName":"createdAt","required":false,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true,"removed":true},{"id":"updatedAt","displayName":"updatedAt","required":true,"defaultMatch":false,"display":true,"type":"dateTime","canBeUsedToMatch":true},{"id":"systemPrompt","displayName":"systemPrompt","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[608,592],"id":"2a97b54b-b385-4aea-9658-c55256513e37","name":"Update System Prompt","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}}},{"parameters":{"respondWith":"json","responseBody":"{\n  \"success\": \"true\"\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[832,592],"id":"3371adc5-7cf7-4050-bc7a-fdbda7587731","name":"Respond to Webhook"},{"parameters":{"respondWith":"json","responseBody":"{\n  \"success\": true\n}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1584,400],"id":"1cd11049-15c3-46a8-9d8b-be7c43d3678b","name":"Respond to Webhook1"},{"parameters":{"operation":"executeQuery","query":"TRUNCATE {{ $('Set Table Prefix').item.json.tablePrefix }}_product_embeddings","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[608,816],"id":"be08057f-0bc5-4a5c-b1fe-4a11faaa0f76","name":"Clear the table","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE {{ $('Set Table Prefix').item.json.tablePrefix }}_product_embeddings (\n  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY, \n  text TEXT, \n  metadata JSONB, \n  embedding VECTOR\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[832,816],"id":"b50ac34c-a5bb-43a0-a4d9-c31f8994fb6e","name":"Create the product table","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}},"onError":"continueRegularOutput"},{"parameters":{"modelName":"models/embedding-001"},"type":"@n8n/n8n-nodes-langchain.embeddingsGoogleGemini","typeVersion":1,"position":[1056,1040],"id":"69abdf21-f8f9-41d6-8fe0-719bb84c90fc","name":"Embeddings Google Gemini1","credentials":{"googlePalmApi":{"id":"06fjQHyU4iIkhwT3","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $('Webhook').item.json.body.text }}","options":{}},"type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1,"position":[1184,1040],"id":"808f82b6-1b50-45b9-bd96-6c584244dca7","name":"Default Data Loader1"},{"parameters":{"chunkSize":200,"options":{}},"type":"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter","typeVersion":1,"position":[1280,1248],"id":"24311963-9952-4d79-ba1f-707509a6d79d","name":"Recursive Character Text Splitter1"},{"parameters":{"mode":"insert","tableName":"={{ $('Set Table Prefix').item.json.tablePrefix }}_product_embeddings","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.1,"position":[1072,816],"id":"d9de51c4-2010-47fd-b509-7a2971d7ff26","name":"Product PGVector Store","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}}},{"parameters":{"mode":"insert","tableName":"={{ $('Set Table Prefix').item.json.tablePrefix }}_embeddings","options":{}},"type":"@n8n/n8n-nodes-langchain.vectorStorePGVector","typeVersion":1.1,"position":[1072,80],"id":"1916712d-85f5-4897-81bc-b5f3a6c48f78","name":"Document PGVector Store","credentials":{"postgres":{"id":"9dKcwCZhB9ThJi1c","name":"RAG"}}},{"parameters":{"respondWith":"json","responseBody":"={\n  \"success\": true,\n  \"company\": \"{{ $json.company }}\"\n} ","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[608,1056],"id":"807e367e-8afe-4a7d-98b1-eade5e76c03f","name":"Return Success"},{"parameters":{"assignments":{"assignments":[{"id":"2583805d-ba15-411d-bf16-6e16e15284ae","name":"tablePrefix","value":"={{ $json.company.replaceSpecialChars().toSnakeCase() }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[0,544],"id":"bc2912e6-4703-4084-8fee-fc9e1695aaa0","name":"Set Table Prefix"}],"connections":{"Embeddings Google Gemini":{"ai_embedding":[[{"node":"Document PGVector Store","type":"ai_embedding","index":0}]]},"Default Data Loader":{"ai_document":[[{"node":"Document PGVector Store","type":"ai_document","index":0}]]},"Recursive Character Text Splitter":{"ai_textSplitter":[[{"node":"Default Data Loader","type":"ai_textSplitter","index":0}]]},"Webhook":{"main":[[{"node":"Date & Time","type":"main","index":0}]]},"Date & Time":{"main":[[{"node":"Validate API Key","type":"main","index":0}]]},"If":{"main":[[{"node":"Set Table Prefix","type":"main","index":0}],[{"node":"API Key Error","type":"main","index":0}]]},"Validate API Key":{"main":[[{"node":"If","type":"main","index":0}]]},"Execute a SQL query":{"main":[[{"node":"Document PGVector Store","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Execute a SQL query","type":"main","index":0}],[{"node":"Return System Prompt","type":"main","index":0}],[{"node":"Update System Prompt","type":"main","index":0}],[{"node":"Clear the table","type":"main","index":0}],[{"node":"Return Success","type":"main","index":0}]]},"Update System Prompt":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Clear the table":{"main":[[{"node":"Create the product table","type":"main","index":0}]]},"Embeddings Google Gemini1":{"ai_embedding":[[{"node":"Product PGVector Store","type":"ai_embedding","index":0}]]},"Default Data Loader1":{"ai_document":[[{"node":"Product PGVector Store","type":"ai_document","index":0}]]},"Recursive Character Text Splitter1":{"ai_textSplitter":[[{"node":"Default Data Loader1","type":"ai_textSplitter","index":0}]]},"Create the product table":{"main":[[{"node":"Product PGVector Store","type":"main","index":0}]]},"Document PGVector Store":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}]]},"Product PGVector Store":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}]]},"Set Table Prefix":{"main":[[{"node":"Switch","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"2a0369a8-ec37-4e8e-b4c3-f2694e1147ac","triggerCount":1,"tags":[{"createdAt":"2025-07-02T03:36:50.683Z","updatedAt":"2025-07-02T03:36:50.683Z","id":"5vXUFxS7I0hK43by","name":"Client"},{"createdAt":"2025-08-21T06:19:53.755Z","updatedAt":"2025-08-21T06:19:53.755Z","id":"6cigMpvd9USGIjgY","name":"Chatbot"},{"createdAt":"2025-06-19T01:47:10.821Z","updatedAt":"2025-06-19T01:47:10.821Z","id":"8gVBkn7dQhRbCEvP","name":"Server"},{"createdAt":"2025-06-19T05:40:26.659Z","updatedAt":"2025-06-19T05:40:26.659Z","id":"CiHXrcv73HXsVpCY","name":"Sales"}]}